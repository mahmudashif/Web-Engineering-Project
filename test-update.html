<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Image Update</title>
</head>
<body>
    <h1>Test Product Image Update</h1>
    
    <!-- Form to create a test product first -->
    <div>
        <h2>Step 1: Add Product</h2>
        <form id="addForm" enctype="multipart/form-data">
            <div>
                <label for="addName">Product Name:</label>
                <input type="text" id="addName" name="name" value="Test Product for Update" required>
            </div>
            <div>
                <label for="addPrice">Price:</label>
                <input type="number" id="addPrice" name="price" value="199.99" step="0.01" required>
            </div>
            <div>
                <label for="addImage">Initial Image:</label>
                <input type="file" id="addImage" name="image" accept="image/*">
            </div>
            <div>
                <button type="submit">Add Product</button>
            </div>
        </form>
    </div>

    <!-- Form to update the product -->
    <div>
        <h2>Step 2: Update Product (with new image)</h2>
        <form id="updateForm" enctype="multipart/form-data">
            <div>
                <label for="productId">Product ID:</label>
                <input type="number" id="productId" name="product_id" placeholder="Enter product ID to update" required>
            </div>
            <div>
                <label for="updateName">Product Name:</label>
                <input type="text" id="updateName" name="name" value="Updated Test Product" required>
            </div>
            <div>
                <label for="updatePrice">Price:</label>
                <input type="number" id="updatePrice" name="price" value="299.99" step="0.01" required>
            </div>
            <div>
                <label for="updateImage">New Image:</label>
                <input type="file" id="updateImage" name="image" accept="image/*">
            </div>
            <div>
                <button type="submit">Update Product</button>
            </div>
        </form>
    </div>
    
    <div id="addResult"></div>
    <div id="updateResult"></div>
    
    <script>
        // Add product form
        document.getElementById('addForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const resultDiv = document.getElementById('addResult');
            
            try {
                const response = await fetch('/api/admin/products/add-product-simple.php', {
                    method: 'POST',
                    body: formData
                });
                
                const responseText = await response.text();
                console.log('Add Response:', responseText);
                
                const result = JSON.parse(responseText);
                
                if (result.success) {
                    resultDiv.innerHTML = '<p style="color: green;">Add Success: ' + result.message + ' (ID: ' + result.data.id + ')</p>';
                    document.getElementById('productId').value = result.data.id;
                } else {
                    resultDiv.innerHTML = '<p style="color: red;">Add Error: ' + result.message + '</p>';
                }
            } catch (error) {
                console.error('Add Error:', error);
                resultDiv.innerHTML = '<p style="color: red;">Add Error: ' + error.message + '</p>';
            }
        });

        // Update product form
        document.getElementById('updateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const productId = document.getElementById('productId').value;
            const imageFile = document.getElementById('updateImage').files[0];
            const resultDiv = document.getElementById('updateResult');
            
            try {
                // Step 1: Upload image if provided
                if (imageFile) {
                    const imageFormData = new FormData();
                    imageFormData.append('image', imageFile);
                    
                    console.log('Uploading image...');
                    const imageResponse = await fetch('/api/admin/products/upload-image.php', {
                        method: 'POST',
                        body: imageFormData
                    });
                    
                    const imageText = await imageResponse.text();
                    console.log('Image upload response:', imageText);
                    
                    const imageResult = JSON.parse(imageText);
                    if (!imageResult.success) {
                        throw new Error('Image upload failed: ' + imageResult.message);
                    }
                    
                    // Step 2: Update product with new image path
                    console.log('Updating product with image path:', imageResult.data.path);
                    const updateData = {
                        name: document.getElementById('updateName').value,
                        price: document.getElementById('updatePrice').value,
                        image: imageResult.data.path
                    };
                    
                    const updateResponse = await fetch(`/api/admin/products/update-product-simple.php?id=${productId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });
                    
                    const updateText = await updateResponse.text();
                    console.log('Update with image response:', updateText);
                    
                    const updateResult = JSON.parse(updateText);
                    if (updateResult.success) {
                        resultDiv.innerHTML = '<p style="color: green;">Update Success: ' + updateResult.message + '</p>';
                    } else {
                        resultDiv.innerHTML = '<p style="color: red;">Update Error: ' + updateResult.message + '</p>';
                    }
                } else {
                    // Update without image
                    const updateData = {
                        name: document.getElementById('updateName').value,
                        price: document.getElementById('updatePrice').value
                    };
                    
                    const updateResponse = await fetch(`/api/admin/products/update-product-simple.php?id=${productId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });
                    
                    const updateText = await updateResponse.text();
                    console.log('Update without image response:', updateText);
                    
                    const updateResult = JSON.parse(updateText);
                    if (updateResult.success) {
                        resultDiv.innerHTML = '<p style="color: green;">Update Success: ' + updateResult.message + '</p>';
                    } else {
                        resultDiv.innerHTML = '<p style="color: red;">Update Error: ' + updateResult.message + '</p>';
                    }
                }
            } catch (error) {
                console.error('Update Error:', error);
                resultDiv.innerHTML = '<p style="color: red;">Update Error: ' + error.message + '</p>';
            }
        });
    </script>
</body>
</html>
